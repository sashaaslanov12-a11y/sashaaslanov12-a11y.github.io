<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç—ã</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        body { 
            font-family: Arial; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 15px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }
        h1 { text-align: center; margin-bottom: 10px; }
        #status { 
            text-align: center; 
            font-size: 18px; 
            font-weight: bold; 
            margin: 15px 0; 
            padding: 10px; 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            border-radius: 8px; 
        }
        #board { width: 100%; max-width: 500px; margin: 0 auto 20px; }
        .board-b72b1 { border: 2px solid #404040; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .white-1e1d7 { background-color: #f0d9b5; }
        .black-3c85d { background-color: #b58863; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        button { 
            padding: 12px 20px; 
            font-size: 16px; 
            border: none; 
            border-radius: 8px; 
            background: var(--tg-theme-button-color, #0088cc); 
            color: var(--tg-theme-button-text-color, #fff); 
            cursor: pointer; 
        }
        button:active { opacity: 0.7; }
        #moveHistory { 
            margin-top: 15px; 
            padding: 15px; 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            border-radius: 8px; 
            max-height: 120px; 
            overflow-y: auto; 
            font-size: 14px;
        }
        .move-item {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            background: var(--tg-theme-bg-color, #fff);
            border-radius: 4px;
        }
        #gameInfo {
            text-align: center;
            padding: 10px;
            background: var(--tg-theme-section-bg-color, #fff);
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>‚ôüÔ∏è –®–∞—Ö–º–∞—Ç—ã</h1>
    <div id="gameInfo">–•–æ–¥–æ–≤: <span id="moveCount">0</span></div>
    <div id="status">–•–æ–¥ –±–µ–ª—ã—Ö</div>
    <div id="board"></div>
    <div class="controls">
        <button onclick="newGame()">üîÑ –ù–æ–≤–∞—è</button>
        <button onclick="undoMove()">‚Ü∂ –û—Ç–º–µ–Ω–∞</button>
        <button onclick="board.flip()">üîÉ –ü–æ–≤–µ—Ä–Ω—É—Ç—å</button>
    </div>
    <div id="moveHistory"></div>
    
    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Å–≤–∞–π–ø—ã
        tg.setHeaderColor('secondary_bg_color');
        tg.setBackgroundColor('bg_color');
        
        let game = new Chess();
        let moveHistory = [];
        let totalMoves = 0;
        
        let board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            onMouseoutSquare: onMouseoutSquare,
            onMouseoverSquare: onMouseoverSquare,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        
        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) || 
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }
        
        function onDrop(source, target) {
            removeHighlights();
            
            let move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            
            if (move === null) return 'snapback';
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ö–æ–¥–∞
            moveHistory.push(move.san);
            totalMoves++;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            updateMoveHistory();
            updateStatus();
            updateMoveCount();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã
            if (game.game_over()) {
                setTimeout(() => {
                    let result = '';
                    if (game.in_checkmate()) {
                        let winner = game.turn() === 'w' ? '–ß–µ—Ä–Ω—ã–µ' : '–ë–µ–ª—ã–µ';
                        result = 'üèÜ –ú–ê–¢! –ü–æ–±–µ–¥–∏–ª–∏ ' + winner + '!';
                    } else if (game.in_draw()) {
                        result = 'ü§ù –ù–∏—á—å—è!';
                    } else if (game.in_stalemate()) {
                        result = 'ü§ù –ü–ê–¢!';
                    }
                    tg.showPopup({
                        title: '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞',
                        message: result + '\n–•–æ–¥–æ–≤: ' + totalMoves,
                        buttons: [{type: 'ok'}]
                    });
                }, 300);
            }
            
            // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —Ö–æ–¥–µ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        function onSnapEnd() {
            board.position(game.fen());
        }
        
        function onMouseoverSquare(square, piece) {
            let moves = game.moves({
                square: square,
                verbose: true
            });
            
            if (moves.length === 0) return;
            
            highlightSquare(square);
            
            for (let i = 0; i < moves.length; i++) {
                highlightSquare(moves[i].to);
            }
        }
        
        function onMouseoutSquare(square, piece) {
            removeHighlights();
        }
        
        function highlightSquare(square) {
            let $square = $('#board .square-' + square);
            let background = $square.hasClass('black-3c85d') ? '#696969' : '#a9a9a9';
            $square.css('background', background);
        }
        
        function removeHighlights() {
            $('#board .square-55d63').css('background', '');
        }
        
        function updateStatus() {
            let status = '';
            let moveColor = game.turn() === 'w' ? '–ë–µ–ª—ã–µ' : '–ß–µ—Ä–Ω—ã–µ';
            
            if (game.in_checkmate()) {
                status = 'üèÜ –ú–ê–¢! ' + (moveColor === '–ë–µ–ª—ã–µ' ? '–ß–µ—Ä–Ω—ã–µ' : '–ë–µ–ª—ã–µ') + ' –ø–æ–±–µ–¥–∏–ª–∏!';
            } else if (game.in_draw()) {
                status = 'ü§ù –ù–∏—á—å—è!';
            } else if (game.in_stalemate()) {
                status = 'ü§ù –ü–ê–¢!';
            } else {
                status = '–•–æ–¥: ' + moveColor;
                if (game.in_check()) {
                    status += ' ‚ö†Ô∏è –®–ê–•!';
                }
            }
            
            document.getElementById('status').textContent = status;
        }
        
        function updateMoveHistory() {
            let html = '<strong>–ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤:</strong><br>';
            for (let i = 0; i < moveHistory.length; i++) {
                if (i % 2 === 0) {
                    html += '<span class="move-item">' + (Math.floor(i/2) + 1) + '. ' + moveHistory[i];
                    if (moveHistory[i + 1]) {
                        html += ' ' + moveHistory[i + 1];
                    }
                    html += '</span> ';
                }
            }
            document.getElementById('moveHistory').innerHTML = html;
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            let historyDiv = document.getElementById('moveHistory');
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }
        
        function updateMoveCount() {
            document.getElementById('moveCount').textContent = totalMoves;
        }
        
        function newGame() {
            tg.showConfirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É?', function(confirmed) {
                if (confirmed) {
                    game.reset();
                    board.start();
                    moveHistory = [];
                    totalMoves = 0;
                    updateStatus();
                    updateMoveHistory();
                    updateMoveCount();
                    
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                }
            });
        }
        
        function undoMove() {
            let move = game.undo();
            if (move) {
                board.position(game.fen());
                moveHistory.pop();
                totalMoves = Math.max(0, totalMoves - 1);
                updateStatus();
                updateMoveHistory();
                updateMoveCount();
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            }
        }
        
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        window.addEventListener('resize', function() {
            board.resize();
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateStatus();
        updateMoveCount();
        
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ç–µ–º—É Telegram
        if (tg.colorScheme === 'dark') {
            document.body.style.background = '#18222d';
        }
    </script>
</body>
</html>
