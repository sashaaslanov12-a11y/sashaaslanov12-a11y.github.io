<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–®–∞—Ö–º–∞—Ç—ã</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            overscroll-behavior: none;
        }
        
        body { 
            font-family: Arial, sans-serif;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            touch-action: pan-y;
        }
        
        #app {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        h1 { 
            text-align: center; 
            margin-bottom: 10px;
            font-size: 22px;
        }
        
        #modeSelect {
            text-align: center;
            margin: 20px 0;
        }
        #modeSelect button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #fff);
            cursor: pointer;
        }
        
        #gameContainer { display: none; }
        
        #status { 
            text-align: center; 
            font-size: 16px; 
            font-weight: bold; 
            margin: 10px 0; 
            padding: 8px; 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            border-radius: 8px; 
        }
        
        #playerInfo {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
            font-size: 13px;
        }
        
        .player {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .player.active {
            font-weight: bold;
            color: var(--tg-theme-button-color, #0088cc);
        }
        
        #boardContainer {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 15px;
            touch-action: none !important;
            -webkit-user-select: none;
            user-select: none;
        }
        
        #board { 
            width: 100%;
            touch-action: none !important;
            -webkit-user-drag: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #board img {
            pointer-events: none;
            -webkit-user-drag: none;
            user-select: none;
        }
        
        .board-b72b1 { 
            border: 2px solid #404040; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            touch-action: none !important;
        }
        
        .white-1e1d7 { background-color: #f0d9b5; }
        .black-3c85d { background-color: #b58863; }
        
        .square-55d63.selected {
            box-shadow: inset 0 0 0 3px yellow !important;
        }
        
        .square-55d63.possible-move::after {
            content: '';
            position: absolute;
            width: 25%;
            height: 25%;
            background: rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        .controls { 
            display: flex; 
            gap: 8px; 
            justify-content: center; 
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        button { 
            padding: 10px 16px; 
            font-size: 14px; 
            border: none; 
            border-radius: 8px; 
            background: var(--tg-theme-button-color, #0088cc); 
            color: var(--tg-theme-button-text-color, #fff); 
            cursor: pointer;
            touch-action: manipulation;
        }
        button:active { 
            opacity: 0.7;
            transform: scale(0.95);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #moveHistory { 
            margin-top: 10px; 
            padding: 10px; 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            border-radius: 8px; 
            max-height: 100px; 
            overflow-y: auto; 
            font-size: 13px;
        }
        
        .move-item {
            display: inline-block;
            margin: 2px;
            padding: 3px 6px;
            background: var(--tg-theme-bg-color, #fff);
            border-radius: 4px;
            font-size: 12px;
        }
        
        #searchingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0088cc;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #clickModeToggle {
            text-align: center;
            margin: 10px 0;
            font-size: 12px;
        }
        
        #clickModeToggle label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>‚ôüÔ∏è –®–∞—Ö–º–∞—Ç—ã</h1>
        
        <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ -->
        <div id="modeSelect">
            <h2 style="font-size: 18px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:</h2>
            <button onclick="startLocalGame()">üë§ –ò–≥—Ä–∞—Ç—å —Å —Å–æ–±–æ–π</button>
            <button onclick="searchOpponent()">üåê –ò–≥—Ä–∞—Ç—å –æ–Ω–ª–∞–π–Ω</button>
        </div>
        
        <!-- –ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ -->
        <div id="searchingOverlay">
            <div class="spinner"></div>
            <h2>üîç –ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</h2>
            <p>–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</p>
            <button onclick="cancelSearch()" style="margin-top: 20px;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
        
        <!-- –ò–≥—Ä–æ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <div id="gameContainer">
            <div id="playerInfo">
                <div class="player" id="player1">
                    <span>‚¨ú</span>
                    <span id="player1Name">–í—ã</span>
                </div>
                <div class="player" id="player2">
                    <span>‚¨õ</span>
                    <span id="player2Name">–°–æ–ø–µ—Ä–Ω–∏–∫</span>
                </div>
            </div>
            
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div id="clickModeToggle">
                <label>
                    <input type="checkbox" id="clickMode" onchange="toggleClickMode()">
                    –†–µ–∂–∏–º –∫–ª–∏–∫–∞ (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
                </label>
            </div>
            
            <div id="status">–•–æ–¥ –±–µ–ª—ã—Ö</div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ—Å–∫–∏ -->
            <div id="boardContainer">
                <div id="board"></div>
            </div>
            
            <div class="controls">
                <button onclick="leaveGame()">üö™ –í—ã–π—Ç–∏</button>
                <button onclick="offerDraw()" id="drawBtn">ü§ù –ù–∏—á—å—è</button>
                <button onclick="resign()">üè≥Ô∏è –°–¥–∞—Ç—å—Å—è</button>
            </div>
            
            <div id="moveHistory"></div>
        </div>
    </div>
    
    <script>
        // ============= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE =============
        const firebaseConfig = {
            apiKey: "AIzaSyAzAyiWKbGDAHguSTvIsnd0-Ki6rMj09Ps",
            authDomain: "chess-bot-83296.firebaseapp.com",
            databaseURL: "https://chess-bot-83296-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chess-bot-83296",
            storageBucket: "chess-bot-83296.firebasestorage.app",
            messagingSenderId: "770339691566",
            appId: "1:770339691566:web:2d7ee1df85497cd18a93bf",
            measurementId: "G-0JEP0N3E66"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ============= TELEGRAM WEB APP =============
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        if (tg.disableVerticalSwipes) {
            tg.disableVerticalSwipes();
        }
        
        // ============= –ë–õ–û–ö–ò–†–û–í–ö–ê –°–í–ê–ô–ü–ê =============
        document.addEventListener('touchmove', function(e) {
            if (!e.target.closest('#moveHistory') && !e.target.closest('#app')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('DOMContentLoaded', function() {
            const boardContainer = document.getElementById('boardContainer');
            if (boardContainer) {
                boardContainer.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: false });
            }
        });
        
        // ============= –ò–ì–†–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =============
        let game = new Chess();
        let board = null;
        let gameId = null;
        let playerId = null;
        let playerColor = null;
        let isOnlineGame = false;
        let moveHistory = [];
        let gameRef = null;
        let waitingRef = null; // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∂–∏–¥–∞–Ω–∏—è
        let selectedSquare = null;
        let isClickMode = false;
        let gameStarted = false; // –ù–û–í–´–ô –§–õ–ê–ì
        let opponentFound = false; // –ù–û–í–´–ô –§–õ–ê–ì
        
        playerId = tg.initDataUnsafe?.user?.id || 'user_' + Math.random().toString(36).substr(2, 9);
        
        // ============= –†–ï–ñ–ò–ú –ö–õ–ò–ö–ê =============
        function toggleClickMode() {
            isClickMode = document.getElementById('clickMode').checked;
            
            if (isClickMode) {
                board = Chessboard('board', {
                    draggable: false,
                    position: game.fen(),
                    onSquareClick: onSquareClick,
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                });
                
                if (playerColor === 'b') {
                    board.orientation('black');
                }
            } else {
                initBoard();
                board.position(game.fen());
                if (playerColor === 'b') {
                    board.orientation('black');
                }
            }
            
            tg.HapticFeedback?.impactOccurred('light');
        }
        
        function onSquareClick(square) {
            $('.square-55d63').removeClass('selected possible-move');
            
            const piece = game.get(square);
            
            if (selectedSquare) {
                const move = game.move({
                    from: selectedSquare,
                    to: square,
                    promotion: 'q'
                });
                
                if (move) {
                    board.position(game.fen());
                    selectedSquare = null;
                    
                    moveHistory.push(move.san);
                    updateMoveHistory();
                    updateStatus();
                    
                    if (isOnlineGame && gameRef) {
                        sendMoveToServer(move);
                    }
                    
                    tg.HapticFeedback?.impactOccurred('medium');
                    checkGameOver();
                } else if (piece && canSelectPiece(piece, square)) {
                    selectedSquare = square;
                    highlightSquare(square);
                    showPossibleMoves(square);
                    tg.HapticFeedback?.impactOccurred('light');
                } else {
                    selectedSquare = null;
                    tg.HapticFeedback?.notificationOccurred('error');
                }
            } else if (piece && canSelectPiece(piece, square)) {
                selectedSquare = square;
                highlightSquare(square);
                showPossibleMoves(square);
                tg.HapticFeedback?.impactOccurred('light');
            }
        }
        
        function canSelectPiece(piece, square) {
            if (game.game_over()) return false;
            
            if (isOnlineGame) {
                if (playerColor === 'w' && piece.color === 'b') return false;
                if (playerColor === 'b' && piece.color === 'w') return false;
                if (game.turn() !== playerColor) return false;
            } else {
                if (game.turn() !== piece.color) return false;
            }
            
            return true;
        }
        
        function highlightSquare(square) {
            $('#board .square-' + square).addClass('selected');
        }
        
        function showPossibleMoves(square) {
            const moves = game.moves({ square: square, verbose: true });
            moves.forEach(move => {
                $('#board .square-' + move.to).addClass('possible-move');
            });
        }
        
        // ============= –†–ï–ñ–ò–ú–´ –ò–ì–†–´ =============
        function startLocalGame() {
            isOnlineGame = false;
            playerColor = 'both';
            gameStarted = true;
            document.getElementById('modeSelect').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('drawBtn').style.display = 'none';
            document.getElementById('player1Name').textContent = '–ë–µ–ª—ã–µ';
            document.getElementById('player2Name').textContent = '–ß–µ—Ä–Ω—ã–µ';
            initBoard();
            updateStatus();
        }
        
        function searchOpponent() {
            isOnlineGame = true;
            opponentFound = false;
            gameStarted = false;
            document.getElementById('searchingOverlay').style.display = 'flex';
            
            const waitingGamesRef = database.ref('waiting_games');
            
            waitingGamesRef.once('value', (snapshot) => {
                const waitingGames = snapshot.val();
                let foundGame = false;
                
                if (waitingGames) {
                    for (let gId in waitingGames) {
                        if (waitingGames[gId].player1 !== playerId) {
                            joinGame(gId);
                            foundGame = true;
                            break;
                        }
                    }
                }
                
                if (!foundGame) {
                    createGame();
                }
            });
        }
        
        function createGame() {
            gameId = 'game_' + Date.now();
            gameRef = database.ref('games/' + gameId);
            
            const gameData = {
                player1: playerId,
                player1Name: tg.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫ 1',
                player2: null,
                player2Name: null,
                fen: game.fen(),
                turn: 'w',
                moves: [],
                status: 'waiting',
                created: Date.now()
            };
            
            gameRef.set(gameData);
            database.ref('waiting_games/' + gameId).set({
                player1: playerId,
                created: Date.now()
            });
            
            playerColor = 'w';
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–ª—É—à–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
            waitingRef = gameRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.player2 && !opponentFound) {
                    opponentFound = true;
                    // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
                    gameRef.off('value', waitingRef);
                    database.ref('waiting_games/' + gameId).remove();
                    startOnlineGame(data);
                }
            });
        }
        
        function joinGame(gId) {
            gameId = gId;
            gameRef = database.ref('games/' + gameId);
            playerColor = 'b';
            opponentFound = true;
            
            gameRef.update({
                player2: playerId,
                player2Name: tg.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫ 2',
                status: 'active'
            });
            
            database.ref('waiting_games/' + gameId).remove();
            
            gameRef.once('value', (snapshot) => {
                startOnlineGame(snapshot.val());
            });
        }
        
        function startOnlineGame(gameData) {
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–≥—Ä–∞ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å
            if (gameStarted) return;
            gameStarted = true;
            
            document.getElementById('searchingOverlay').style.display = 'none';
            document.getElementById('modeSelect').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            
            if (playerColor === 'w') {
                document.getElementById('player1Name').textContent = '–í—ã (‚¨ú)';
                document.getElementById('player2Name').textContent = gameData.player2Name || '–°–æ–ø–µ—Ä–Ω–∏–∫';
            } else {
                document.getElementById('player1Name').textContent = gameData.player1Name || '–°–æ–ø–µ—Ä–Ω–∏–∫';
                document.getElementById('player2Name').textContent = '–í—ã (‚¨õ)';
            }
            
            initBoard();
            
            if (playerColor === 'b') {
                board.orientation('black');
            }
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–≥—Ä—ã
            gameRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && gameStarted) {
                    updateGameFromServer(data);
                }
            });
            
            updateStatus();
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º popup —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            tg.showPopup({
                title: '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! üéÆ',
                message: '–°–æ–ø–µ—Ä–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω. –£–¥–∞—á–∏!',
                buttons: [{type: 'ok'}]
            });
            
            tg.HapticFeedback?.notificationOccurred('success');
        }
        
        function cancelSearch() {
            if (gameRef && waitingRef) {
                gameRef.off('value', waitingRef);
                gameRef.remove();
            }
            if (gameId) {
                database.ref('waiting_games/' + gameId).remove();
            }
            location.reload();
        }
        
        function leaveGame() {
            tg.showConfirm('–í—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã?', (confirmed) => {
                if (confirmed) {
                    if (gameRef && isOnlineGame) {
                        gameRef.update({ 
                            status: 'abandoned',
                            winner: playerColor === 'w' ? 'b' : 'w'
                        });
                        gameRef.off();
                    }
                    location.reload();
                }
            });
        }
        
        function resign() {
            tg.showConfirm('–°–¥–∞—Ç—å—Å—è?', (confirmed) => {
                if (confirmed) {
                    if (isOnlineGame && gameRef) {
                        gameRef.update({
                            status: 'finished',
                            winner: playerColor === 'w' ? 'b' : 'w',
                            result: 'resignation'
                        });
                    }
                    tg.showAlert('–í—ã —Å–¥–∞–ª–∏—Å—å');
                }
            });
        }
        
        function offerDraw() {
            if (isOnlineGame && gameRef) {
                tg.showConfirm('–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–∏—á—å—é?', (confirmed) => {
                    if (confirmed) {
                        gameRef.child('drawOffer').set(playerColor);
                        tg.showAlert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                    }
                });
            }
        }
        
        // ============= –®–ê–•–ú–ê–¢–ù–ê–Ø –õ–û–ì–ò–ö–ê =============
        function initBoard() {
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                moveSpeed: 'fast',
                snapbackSpeed: 200,
                snapSpeed: 50
            };
            
            board = Chessboard('board', config);
            game.reset();
            moveHistory = [];
        }
        
        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            
            if (isOnlineGame) {
                if (playerColor === 'w' && piece.search(/^b/) !== -1) return false;
                if (playerColor === 'b' && piece.search(/^w/) !== -1) return false;
                if (game.turn() !== playerColor) return false;
            } else {
                if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                    (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                    return false;
                }
            }
        }
        
        function onDrop(source, target) {
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            
            if (move === null) return 'snapback';
            
            moveHistory.push(move.san);
            updateMoveHistory();
            updateStatus();
            
            if (isOnlineGame && gameRef) {
                sendMoveToServer(move);
            }
            
            tg.HapticFeedback?.impactOccurred('light');
            checkGameOver();
        }
        
        function onSnapEnd() {
            board.position(game.fen());
        }
        
        function sendMoveToServer(move) {
            gameRef.update({
                fen: game.fen(),
                turn: game.turn(),
                moves: moveHistory,
                lastMove: {
                    from: move.from,
                    to: move.to,
                    san: move.san,
                    timestamp: Date.now()
                }
            });
        }
        
        function checkGameOver() {
            if (game.game_over()) {
                let result = {};
                if (game.in_checkmate()) {
                    result = {
                        status: 'finished',
                        winner: game.turn() === 'w' ? 'b' : 'w',
                        result: 'checkmate'
                    };
                } else {
                    result = {
                        status: 'finished',
                        winner: 'draw',
                        result: game.in_stalemate() ? 'stalemate' : 'draw'
                    };
                }
                
                if (isOnlineGame && gameRef) {
                    gameRef.update(result);
                }
            }
        }
        
        function updateGameFromServer(data) {
            if (!data) return;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
            if (data.fen && data.fen !== game.fen()) {
                game.load(data.fen);
                board.position(data.fen);
                moveHistory = data.moves || [];
                updateMoveHistory();
                updateStatus();
                
                tg.HapticFeedback?.notificationOccurred('success');
            }
            
            // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∏—á—å–µ–π
            if (data.drawOffer && data.drawOffer !== playerColor) {
                gameRef.child('drawOffer').remove();
                tg.showConfirm('–°–æ–ø–µ—Ä–Ω–∏–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∏—á—å—é. –ü—Ä–∏–Ω—è—Ç—å?', (confirmed) => {
                    if (confirmed) {
                        gameRef.update({
                            status: 'finished',
                            winner: 'draw',
                            result: 'agreement'
                        });
                    }
                });
            }
            
            // –û–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã
            if (data.status === 'finished') {
                let message = '';
                if (data.winner === playerColor) {
                    message = 'üèÜ –í—ã –ø–æ–±–µ–¥–∏–ª–∏!';
                } else if (data.winner === 'draw') {
                    message = 'ü§ù –ù–∏—á—å—è!';
                } else {
                    message = 'üòû –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
                if (!sessionStorage.getItem('gameEnded_' + gameId)) {
                    sessionStorage.setItem('gameEnded_' + gameId, 'true');
                    setTimeout(() => {
                        tg.showPopup({
                            title: '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞',
                            message: message,
                            buttons: [{type: 'ok'}]
                        });
                    }, 500);
                }
            }
            
            if (data.status === 'abandoned') {
                if (!sessionStorage.getItem('gameAbandoned_' + gameId)) {
                    sessionStorage.setItem('gameAbandoned_' + gameId, 'true');
                    tg.showAlert('–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∏–≥—Ä—É');
                }
            }
        }
        
        function updateStatus() {
            let status = '';
            let moveColor = game.turn() === 'w' ? '–ë–µ–ª—ã–µ' : '–ß–µ—Ä–Ω—ã–µ';
            
            document.getElementById('player1').classList.remove('active');
            document.getElementById('player2').classList.remove('active');
            
            if (isOnlineGame) {
                if ((playerColor === 'w' && game.turn() === 'w') ||
                    (playerColor === 'b' && game.turn() === 'b')) {
                    status = 'üü¢ –í–∞—à —Ö–æ–¥';
                    if (playerColor === 'w') {
                        document.getElementById('player1').classList.add('active');
                    } else {
                        document.getElementById('player2').classList.add('active');
                    }
                } else {
                    status = '‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
                    if (playerColor === 'w') {
                        document.getElementById('player2').classList.add('active');
                    } else {
                        document.getElementById('player1').classList.add('active');
                    }
                }
            } else {
                status = '–•–æ–¥: ' + moveColor;
                if (game.turn() === 'w') {
                    document.getElementById('player1').classList.add('active');
                } else {
                    document.getElementById('player2').classList.add('active');
                }
            }
            
            if (game.in_checkmate()) {
                status = 'üèÜ –ú–ê–¢! ' + (moveColor === '–ë–µ–ª—ã–µ' ? '–ß–µ—Ä–Ω—ã–µ' : '–ë–µ–ª—ã–µ') + ' –ø–æ–±–µ–¥–∏–ª–∏!';
            } else if (game.in_draw()) {
                status = 'ü§ù –ù–∏—á—å—è!';
            } else if (game.in_check()) {
                status += ' ‚ö†Ô∏è –®–ê–•!';
            }
            
            document.getElementById('status').textContent = status;
        }
        
        function updateMoveHistory() {
            let html = '<strong>–ò—Å—Ç–æ—Ä–∏—è:</strong><br>';
            for (let i = 0; i < moveHistory.length; i++) {
                if (i % 2 === 0) {
                    html += '<span class="move-item">' + (Math.floor(i/2) + 1) + '. ' + moveHistory[i];
                    if (moveHistory[i + 1]) {
                        html += ' ' + moveHistory[i + 1];
                    }
                    html += '</span> ';
                }
            }
            document.getElementById('moveHistory').innerHTML = html;
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            const historyDiv = document.getElementById('moveHistory');
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }
        
        // –ó–∞–ø—Ä–µ—Ç –∂–µ—Å—Ç–æ–≤ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
