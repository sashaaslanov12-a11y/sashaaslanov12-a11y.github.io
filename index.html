<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç—ã</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        body { 
            font-family: Arial; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 15px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }
        h1 { text-align: center; margin-bottom: 10px; }
        
        #modeSelect {
            text-align: center;
            margin: 20px 0;
        }
        #modeSelect button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #fff);
            cursor: pointer;
        }
        
        #gameContainer { display: none; }
        
        #status { 
            text-align: center; 
            font-size: 18px; 
            font-weight: bold; 
            margin: 15px 0; 
            padding: 10px; 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            border-radius: 8px; 
        }
        
        #playerInfo {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .player {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .player.active {
            font-weight: bold;
            color: var(--tg-theme-button-color, #0088cc);
        }
        
        #board { width: 100%; max-width: 500px; margin: 0 auto 20px; }
        .board-b72b1 { border: 2px solid #404040; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .white-1e1d7 { background-color: #f0d9b5; }
        .black-3c85d { background-color: #b58863; }
        
        .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        button { 
            padding: 12px 20px; 
            font-size: 16px; 
            border: none; 
            border-radius: 8px; 
            background: var(--tg-theme-button-color, #0088cc); 
            color: var(--tg-theme-button-text-color, #fff); 
            cursor: pointer; 
        }
        button:active { opacity: 0.7; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #moveHistory { 
            margin-top: 15px; 
            padding: 15px; 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            border-radius: 8px; 
            max-height: 120px; 
            overflow-y: auto; 
            font-size: 14px;
        }
        
        .move-item {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            background: var(--tg-theme-bg-color, #fff);
            border-radius: 4px;
        }
        
        #searchingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0088cc;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>‚ôüÔ∏è –®–∞—Ö–º–∞—Ç—ã</h1>
    
    <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ -->
    <div id="modeSelect">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏–≥—Ä—ã:</h2>
        <button onclick="startLocalGame()">üë§ –ò–≥—Ä–∞—Ç—å —Å —Å–æ–±–æ–π</button>
        <button onclick="searchOpponent()">üåê –ò–≥—Ä–∞—Ç—å –æ–Ω–ª–∞–π–Ω</button>
    </div>
    
    <!-- –ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ -->
    <div id="searchingOverlay">
        <div class="spinner"></div>
        <h2>üîç –ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</h2>
        <p>–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</p>
        <button onclick="cancelSearch()" style="margin-top: 20px;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>
    
    <!-- –ò–≥—Ä–æ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div id="gameContainer">
        <div id="playerInfo">
            <div class="player" id="player1">
                <span>‚¨ú</span>
                <span id="player1Name">–í—ã</span>
            </div>
            <div class="player" id="player2">
                <span>‚¨õ</span>
                <span id="player2Name">–°–æ–ø–µ—Ä–Ω–∏–∫</span>
            </div>
        </div>
        
        <div id="status">–•–æ–¥ –±–µ–ª—ã—Ö</div>
        <div id="board"></div>
        
        <div class="controls">
            <button onclick="leaveGame()">üö™ –í—ã–π—Ç–∏</button>
            <button onclick="offerDraw()" id="drawBtn">ü§ù –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–∏—á—å—é</button>
            <button onclick="resign()">üè≥Ô∏è –°–¥–∞—Ç—å—Å—è</button>
        </div>
        
        <div id="moveHistory"></div>
    </div>
    
    <script>
        // ============= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE =============
        // üëá –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–£ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Æ –ò–ó FIREBASE
        const firebaseConfig = {
        apiKey: "AIzaSyAzAyiWKbGDAHguSTvIsnd0-Ki6rMj09Ps",
        authDomain: "chess-bot-83296.firebaseapp.com",
        databaseURL: "https://chess-bot-83296-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "chess-bot-83296",
        storageBucket: "chess-bot-83296.firebasestorage.app",
        messagingSenderId: "770339691566",
        appId: "1:770339691566:web:2d7ee1df85497cd18a93bf",
        measurementId: "G-0JEP0N3E66"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ============= TELEGRAM WEB APP =============
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // ============= –ò–ì–†–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =============
        let game = new Chess();
        let board = null;
        let gameId = null;
        let playerId = null;
        let playerColor = null;
        let isOnlineGame = false;
        let moveHistory = [];
        let gameRef = null;
        
        // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        playerId = tg.initDataUnsafe?.user?.id || 'user_' + Math.random().toString(36).substr(2, 9);
        
        // ============= –†–ï–ñ–ò–ú–´ –ò–ì–†–´ =============
        
        function startLocalGame() {
            isOnlineGame = false;
            playerColor = 'both';
            document.getElementById('modeSelect').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('drawBtn').style.display = 'none';
            initBoard();
            updateStatus();
        }
        
        function searchOpponent() {
            isOnlineGame = true;
            document.getElementById('searchingOverlay').style.display = 'flex';
            
            // –ü–æ–∏—Å–∫ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∏–≥—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π
            const waitingGamesRef = database.ref('waiting_games');
            
            waitingGamesRef.once('value', (snapshot) => {
                const waitingGames = snapshot.val();
                let foundGame = false;
                
                // –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –∏–≥—Ä—É
                if (waitingGames) {
                    for (let gId in waitingGames) {
                        if (waitingGames[gId].player1 !== playerId) {
                            // –ù–∞–π–¥–µ–Ω–∞ –∏–≥—Ä–∞!
                            joinGame(gId);
                            foundGame = true;
                            break;
                        }
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
                if (!foundGame) {
                    createGame();
                }
            });
        }
        
        function createGame() {
            gameId = 'game_' + Date.now();
            gameRef = database.ref('games/' + gameId);
            
            const gameData = {
                player1: playerId,
                player1Name: tg.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫ 1',
                player2: null,
                player2Name: null,
                fen: game.fen(),
                turn: 'w',
                moves: [],
                status: 'waiting',
                created: Date.now()
            };
            
            gameRef.set(gameData);
            database.ref('waiting_games/' + gameId).set({
                player1: playerId,
                created: Date.now()
            });
            
            playerColor = 'w';
            
            // –°–ª—É—à–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
            gameRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.player2) {
                    // –°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!
                    database.ref('waiting_games/' + gameId).remove();
                    startOnlineGame(data);
                }
            });
        }
        
        function joinGame(gId) {
            gameId = gId;
            gameRef = database.ref('games/' + gameId);
            playerColor = 'b';
            
            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∏–≥—Ä–µ
            gameRef.update({
                player2: playerId,
                player2Name: tg.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫ 2',
                status: 'active'
            });
            
            database.ref('waiting_games/' + gameId).remove();
            
            gameRef.once('value', (snapshot) => {
                startOnlineGame(snapshot.val());
            });
        }
        
        function startOnlineGame(gameData) {
            document.getElementById('searchingOverlay').style.display = 'none';
            document.getElementById('modeSelect').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º–µ–Ω–∞ –∏–≥—Ä–æ–∫–æ–≤
            if (playerColor === 'w') {
                document.getElementById('player1Name').textContent = '–í—ã (–ë–µ–ª—ã–µ)';
                document.getElementById('player2Name').textContent = gameData.player2Name || '–°–æ–ø–µ—Ä–Ω–∏–∫';
            } else {
                document.getElementById('player1Name').textContent = gameData.player1Name || '–°–æ–ø–µ—Ä–Ω–∏–∫';
                document.getElementById('player2Name').textContent = '–í—ã (–ß–µ—Ä–Ω—ã–µ)';
            }
            
            initBoard();
            
            // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ–º —á–µ—Ä–Ω—ã–º–∏, –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–æ—Å–∫—É
            if (playerColor === 'b') {
                board.orientation('black');
            }
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∏–≥—Ä–µ
            gameRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateGameFromServer(data);
                }
            });
            
            updateStatus();
            
            tg.showPopup({
                title: '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!',
                message: '–°–æ–ø–µ—Ä–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω. –£–¥–∞—á–∏!',
                buttons: [{type: 'ok'}]
            });
        }
        
        function cancelSearch() {
            if (gameRef) {
                gameRef.remove();
                database.ref('waiting_games/' + gameId).remove();
            }
            location.reload();
        }
        
        function leaveGame() {
            tg.showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?', (confirmed) => {
                if (confirmed) {
                    if (gameRef && isOnlineGame) {
                        gameRef.update({ 
                            status: 'abandoned',
                            winner: playerColor === 'w' ? 'b' : 'w'
                        });
                        gameRef.off();
                    }
                    location.reload();
                }
            });
        }
        
        function resign() {
            tg.showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–∞—Ç—å—Å—è?', (confirmed) => {
                if (confirmed) {
                    if (isOnlineGame && gameRef) {
                        gameRef.update({
                            status: 'finished',
                            winner: playerColor === 'w' ? 'b' : 'w',
                            result: 'resignation'
                        });
                    }
                    tg.showAlert('–í—ã —Å–¥–∞–ª–∏—Å—å');
                }
            });
        }
        
        function offerDraw() {
            if (isOnlineGame && gameRef) {
                tg.showConfirm('–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–∏—á—å—é —Å–æ–ø–µ—Ä–Ω–∏–∫—É?', (confirmed) => {
                    if (confirmed) {
                        gameRef.child('drawOffer').set(playerColor);
                        tg.showAlert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                    }
                });
            }
        }
        
        // ============= –®–ê–•–ú–ê–¢–ù–ê–Ø –õ–û–ì–ò–ö–ê =============
        
        function initBoard() {
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            
            board = Chessboard('board', config);
            game.reset();
            moveHistory = [];
        }
        
        function onDragStart(source, piece) {
            // –ó–∞–ø—Ä–µ—Ç —Ö–æ–¥–∞ –µ—Å–ª–∏ –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
            if (game.game_over()) return false;
            
            // –í –æ–Ω–ª–∞–π–Ω –∏–≥—Ä–µ - —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ñ–∏–≥—É—Ä—ã –∏ —Å–≤–æ–π —Ö–æ–¥
            if (isOnlineGame) {
                if (playerColor === 'w' && piece.search(/^b/) !== -1) return false;
                if (playerColor === 'b' && piece.search(/^w/) !== -1) return false;
                if (game.turn() !== playerColor) return false;
            } else {
                // –í –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ - –ø–æ –æ—á–µ—Ä–µ–¥–∏
                if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                    (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                    return false;
                }
            }
        }
        
        function onDrop(source, target) {
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            
            if (move === null) return 'snapback';
            
            moveHistory.push(move.san);
            updateMoveHistory();
            updateStatus();
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ö–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            if (isOnlineGame && gameRef) {
                gameRef.update({
                    fen: game.fen(),
                    turn: game.turn(),
                    moves: moveHistory,
                    lastMove: {
                        from: source,
                        to: target,
                        san: move.san,
                        timestamp: Date.now()
                    }
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã
                if (game.game_over()) {
                    let result = {};
                    if (game.in_checkmate()) {
                        result = {
                            status: 'finished',
                            winner: game.turn() === 'w' ? 'b' : 'w',
                            result: 'checkmate'
                        };
                    } else {
                        result = {
                            status: 'finished',
                            winner: 'draw',
                            result: game.in_stalemate() ? 'stalemate' : 'draw'
                        };
                    }
                    gameRef.update(result);
                }
            }
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        function onSnapEnd() {
            board.position(game.fen());
        }
        
        function updateGameFromServer(data) {
            if (!data) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –µ—Å–ª–∏ –æ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
            if (data.fen !== game.fen()) {
                game.load(data.fen);
                board.position(data.fen);
                moveHistory = data.moves || [];
                updateMoveHistory();
                updateStatus();
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∏—á—å–∏
            if (data.drawOffer && data.drawOffer !== playerColor) {
                gameRef.child('drawOffer').remove();
                tg.showConfirm('–°–æ–ø–µ—Ä–Ω–∏–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∏—á—å—é. –ü—Ä–∏–Ω—è—Ç—å?', (confirmed) => {
                    if (confirmed) {
                        gameRef.update({
                            status: 'finished',
                            winner: 'draw',
                            result: 'agreement'
                        });
                    }
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã
            if (data.status === 'finished') {
                let message = '';
                if (data.winner === playerColor) {
                    message = 'üèÜ –í—ã –ø–æ–±–µ–¥–∏–ª–∏!';
                } else if (data.winner === 'draw') {
                    message = 'ü§ù –ù–∏—á—å—è!';
                } else {
                    message = 'üòû –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏';
                }
                
                setTimeout(() => {
                    tg.showPopup({
                        title: '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞',
                        message: message,
                        buttons: [{type: 'ok'}]
                    });
                }, 500);
            }
            
            if (data.status === 'abandoned') {
                tg.showAlert('–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∏–≥—Ä—É. –í—ã –ø–æ–±–µ–¥–∏–ª–∏!');
            }
        }
        
        function updateStatus() {
            let status = '';
            let moveColor = game.turn() === 'w' ? '–ë–µ–ª—ã–µ' : '–ß–µ—Ä–Ω—ã–µ';
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            document.getElementById('player1').classList.remove('active');
            document.getElementById('player2').classList.remove('active');
            
            if (isOnlineGame) {
                if ((playerColor === 'w' && game.turn() === 'w') ||
                    (playerColor === 'b' && game.turn() === 'b')) {
                    status = 'üü¢ –í–∞—à —Ö–æ–¥';
                    if (playerColor === 'w') {
                        document.getElementById('player1').classList.add('active');
                    } else {
                        document.getElementById('player2').classList.add('active');
                    }
                } else {
                    status = '‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
                    if (playerColor === 'w') {
                        document.getElementById('player2').classList.add('active');
                    } else {
                        document.getElementById('player1').classList.add('active');
                    }
                }
            } else {
                status = '–•–æ–¥: ' + moveColor;
                if (game.turn() === 'w') {
                    document.getElementById('player1').classList.add('active');
                } else {
                    document.getElementById('player2').classList.add('active');
                }
            }
            
            if (game.in_checkmate()) {
                status = 'üèÜ –ú–ê–¢! ' + (moveColor === '–ë–µ–ª—ã–µ' ? '–ß–µ—Ä–Ω—ã–µ' : '–ë–µ–ª—ã–µ') + ' –ø–æ–±–µ–¥–∏–ª–∏!';
            } else if (game.in_draw()) {
                status = 'ü§ù –ù–∏—á—å—è!';
            } else if (game.in_check()) {
                status += ' ‚ö†Ô∏è –®–ê–•!';
            }
            
            document.getElementById('status').textContent = status;
        }
        
        function updateMoveHistory() {
            let html = '<strong>–ò—Å—Ç–æ—Ä–∏—è:</strong><br>';
            for (let i = 0; i < moveHistory.length; i++) {
                if (i % 2 === 0) {
                    html += '<span class="move-item">' + (Math.floor(i/2) + 1) + '. ' + moveHistory[i];
                    if (moveHistory[i + 1]) {
                        html += ' ' + moveHistory[i + 1];
                    }
                    html += '</span> ';
                }
            }
            document.getElementById('moveHistory').innerHTML = html;
        }
        
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è
        window.addEventListener('resize', () => { if (board) board.resize(); });
    </script>
</body>
</html>
